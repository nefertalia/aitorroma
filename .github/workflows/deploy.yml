name: Build and Deploy
on:
  schedule:
    - cron: "0 0 * * *" # Every day at midnight.
  workflow_dispatch:
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Configurar pipenv
        uses: dschep/install-pipenv-action@v1
        with:
          version: 2020.8.13

      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v2.3.2 
        with:
          persist-credentials: false

      - name: Instalando üîß 
        run: |
          sudo apt-get update
          sudo apt-get install -y libgconf-2-4 wget xvfb unzip curl
          sudo wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub |sudo  apt-key add -
          sudo echo "deb http://dl.google.com/linux/chrome/deb/ stable main" |sudo tee -a /etc/apt/sources.list.d/google.list
          sudo apt-get update -y
          sudo apt-get install -y google-chrome-stable 
          sudo mkdir /chromedriver
          sudo wget -q --continue -P /chromedriver "https://chromedriver.storage.googleapis.com/87.0.4280.88/chromedriver_linux64.zip"
          sudo unzip /chromedriver/* -d /chromedriver
          export PATH=$PATH:/chromedriver
          pipenv install
          pipenv run python loconotion  project/aitorroma.com.toml --non-headless
          cp -Rf project/assets dist/aitor-roma

      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GH_SECRET }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: dist/aitor-roma # The folder the action should deploy.
          CLEAN: true

      - name: Purgar cache de Cloudflare ‚õÖ
        uses: jakejarvis/cloudflare-purge-action@master
        env:
          CLOUDFLARE_ZONE: ${{ secrets.CLOUDFLARE_ZONE }}
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
